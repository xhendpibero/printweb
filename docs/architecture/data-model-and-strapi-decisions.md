# Data Model + Strapi Decisions (v2)

This version turns the earlier questions into concrete decisions so we can scaffold Strapi and the API without ambiguity. Any open items are listed at the end with a short action to close.

## Summary Of Agreed Decisions

- Auth: Use Strapi Users & Permissions (U&P). Simple, built‑in CRUD and roles. Next.js talks to Strapi via REST.
- Organizations: One user owns exactly one organization. Users created in client panel become members of the owner’s org. No multi‑org membership.
- Pricing rules: Stored in Strapi as JSON on the product configurator (MVP).
- Currencies: PLN, EUR, USD supported. Money is an object using integer minor units.
- Configurator: All core field types supported; products decide which are required (include "None" options as needed). Options can have images and price modifiers.
- Uploads: Strapi Upload plugin with local provider (MVP). Max file size 2 MB. Allowed MIME: PDF, JPEG, PNG, TIFF. Required pages per product.
- Shipment: Pricing per address and by item weight. Multiple addresses supported. Anonymous shipping is a boolean flag.
- Payments: Enable only "Transfer" and "I will choose later" (deferred). Others disabled. Deferred creates orders with `on_hold`.
- Orders lifecycle: `draft → on_hold | awaiting_payment → processing → shipped → delivered | canceled`.
- On‑hold release: Admin only (via Strapi Admin for MVP). Validation requires completeness of files/shipment/payment.
- Invoices: Country‑aware numbering and e‑invoice consent linkage. Period ZIP downloads generated by Strapi.
- Discounts/Promos/Coupons: Flexible; default applied at order total. Stacking configurable.
- Cashback: Not in MVP (scaffold types only, disable UI).
- Messages: Two‑way support; text and image attachments allowed.
- Settings: Account details sync with default addresses. Transfer details per organization. FTP credentials per user (low priority).
- i18n: English only for MVP (Strapi i18n disabled initially).
- IDs & numbering: ULID for IDs. Order number format `Z-YYYY-NNNNN` issued by Strapi with per‑year counter.
- Frontend routes: `/order/cart`, `/order/upload`, `/order/shipment-address`, `/order/payment`, `/order/summary`.
- API prefix: `/api/order/*` for checkout, `/api/panel/*` for client panel.

## Money Model

- Shape: `{ amountMinor: number; currency: 'PLN'|'EUR'|'USD' }`
- Semantics: `amountMinor` is integer minor units (grosz/cents). No floats in responses.
- Display: Frontend formats to 2 decimals by currency. VAT amounts are derived; we store both net and gross totals on cart/order.

## Strapi Content Types (collections)

- `organization`
  - owner (user), name, taxId?, billingAddress (component `shared.address`), transferDetails (component), defaultCurrency
- `user` (Strapi U&P) + profile fields via component or direct columns
  - firstName, lastName, phone, org (relation), orgRole: enum `admin|member`
- `address`
  - org (relation), type: `shipping|invoice`, label, isDefault, firstName, lastName, company?, taxId?, street, city, postalCode, country, phone?
- `category`
  - name, slug, parent (self), sortOrder
- `product`
  - name, slug, description, status, category (rel), images (media), basePrice (Money), productType (enum), configurator (rel 1‑1), weightGrams (number)
- `configurator`
  - product (rel), fields (component repeatable), pricingRules (component repeatable JSON), validationRules (component repeatable)
- `cart`
  - org (rel) or user (rel), currency, printingNet (Money), deliveryNet (Money), totalNet (Money), totalGross (Money), status `active|abandoned|converted`
- `cart-item`
  - cart (rel), product (rel), configuration (JSON), copies, unitPrice (Money), totalPrice (Money), shippingMethod?, fingerprint
- `upload`
  - cartItem (rel), status `queued|uploading|processing|done|error`, files (component repeatable), errorMessage?
- `shipment`
  - cart (rel), mode `one|multiple`, addresses (rel many), assignments (JSON of itemId→splits), anonymous:boolean
- `payment-intent`
  - cart (rel), method: `transfer|deferred`, status, amount (Money), currency, providerPayload (JSON)
- `order`
  - orderNumber, org (rel) or user (rel), status, subtotal/shipping/tax/total (Money), currency,
    shippingAddress (component), billingAddress (component), paymentStatus, paymentMethod, createdAt
- `order-item`
  - order (rel), product (rel), configuration (JSON), quantity, unitPrice/totalPrice (Money), productionFiles (media/rel to upload files)
- `invoice`
  - order (rel), number, issueDate, dueDate, totals (Money), currency, pdfUrl, series, country
- `promotion`
  - name, description, startsAt, endsAt, status, conditions (JSON)
- `coupon`
  - code, discountPct or amount (Money), validFrom/To, usageLimits, promotion (rel), stacking: boolean
- `message-thread`
  - org (rel), subject, lastMessageAt, unreadCount
- `message`
  - thread (rel), author: `system|support|user`, body (text), attachments (images), createdAt
- `marketing-consent`
  - user (rel), email:boolean, phone:boolean, updatedAt, updatedBy (user rel)

## Strapi Components

- `shared.money` → amountMinor:int, currency
- `shared.address` → normalized address fields
- `configurator.field` → id, type, name, label, required, options (component), validation (JSON)
- `configurator.option` → id, label, value, priceModifier (Money or numeric), image
- `pricing.rule` → id, condition (JSON), modifier:number, type:enum `percentage|fixed`
- `upload.file` → name, size, mime, pages?, url
- `org.transferDetails` → bic, accounts [{currency, ibanOrNumber}], recipient {name, addressLines[], country}, transferTitleHint

## Endpoints (aligned with routes)

- Cart step: `/api/order/cart` and `/api/order/cart/*`
- Uploads: `/api/order/uploads/*`
- Shipment: `/api/order/shipment/*`
- Payment: `/api/order/payment/*`
- Summary & placement: `/api/order/summary`, `/api/order/place`
- Confirmation: `/api/order/confirmation`
- Panel resources: `/api/panel/addresses`, `/api/panel/orders`, `/api/panel/invoices`, `/api/panel/discounts`, `/api/panel/messages`, `/api/panel/settings/*`

## Status & Completeness

- FileStatus: `missing|uploaded|approved`
- ShipmentMode: `one|multiple`
- Completeness flags on summary result: `filesComplete`, `shipmentComplete`, `paymentComplete`, `missing: string[]`, `canPlaceOnHold`.
- Releasing on‑hold: Strapi Admin action checks flags and transitions to `awaiting_payment` or directly to `processing` when payment method is `transfer` and verified by admin.

## Payments (enabled)

- `transfer`: show org transferDetails; order set to `awaiting_payment` after place; admin marks paid.
- `deferred` (I will choose later): order set to `on_hold`.

## Shipment Pricing

- Compute per address: sum(weight × rate) per item split. Rate tables stored in Strapi per country/method (MVP keep a simple per‑kg table per country).

## Invoices

- Numbering: per country, per year series. Example: `INV-PL-2025-000123`.
- E‑invoice consent determines electronic delivery only.
- Period download: Strapi bundles PDF links into a ZIP and streams.

## Admin vs Custom Admin Dashboard

- MVP: Use Strapi Admin for order release, payment marking, and invoice generation.
- Future: optional custom admin UI; keep service layer in Strapi so UI can be swapped.

## Remaining Questions (short list)

1) VAT rules: one global VAT per org country, or per product category? MVP: global per org country (confirm default PL 23%).
2) Weight source: add `weightGrams` per product variant derived from configurator (confirm field location).
3) Storage: 2 MB may be too small for print; keep 2 MB for MVP or raise to 50–200 MB? (confirm).
4) Discounts stacking default: disabled or enabled? MVP proposal: disabled (explicit opt‑in per coupon).
5) Payment verification: who sets payment as `completed` for transfer? Admin only (confirm).

## Next Steps

- Lock the remaining questions above.
- Generate Strapi CTs/components from this spec.
- Implement `/api/order/*` endpoints and minimal pricing/shipping calculators.
- Wire frontend pages to these endpoints using the agreed Money and routes.

